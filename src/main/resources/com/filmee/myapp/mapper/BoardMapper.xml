<?xml version="1.0" encoding="UTF-8"?>


<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.filmee.myapp.mapper.BoardMapper">

    <select id="getList" resultType="com.filmee.myapp.domain.BoardVO">

        SELECT /*+index_desc(fm_board)*/*
        FROM fm_board
        <where>
            <choose>
                <when test="type eq 'T'.toString()">
                    title LIKE '%'||#{keyword}||'%'
                </when>

                <when test="type eq 'C'.toString()">
                    content LIKE '%'||#{keyword}||'%'
                </when>

                <when test="type eq 'W'.toString()">
                    writer LIKE '%'||#{keyword}||'%'
                </when>
                
                <when test="category eq 'F'.toString()">
                	category='F'
                </when>
                                
                <when test="category eq 'R'.toString()">
                	category='R'
                </when>
                                
                <when test="category eq 'B'.toString()">
                	category='B'
                </when>
                                
                <when test="category eq 'N'.toString()">
                	category='N'
                </when>
					
              </choose>
        </where>
        OFFSET (#{currPage}-1) * #{amount} ROW
        FETCH NEXT #{amount} ROWS ONLY

    </select>

    <select id="select" resultType="com.filmee.myapp.domain.BoardVO">
      <![CDATA[ 
        SELECT *
        FROM fm_board
        WHERE bno=#{bno}
      ]]>
    </select>

    <insert id="insertSelectKey">
      <selectKey keyProperty="bno" order="BEFORE" resultType="int">
        SELECT ISEQ$$_101436.nextval FROM dual
      </selectKey>
      <![CDATA[ 
        INSERT INTO fm_board(writer, category, title, content)
        VALUES(#{writer},#{category},#{title}, #{content})
      ]]>
    </insert>

    <update id="update">
      <![CDATA[ 
        UPDATE fm_board
        SET title=#{title}, category=#{category}, CONTENT=#{content}, update_ts=current_date
        WHERE bno=#{bno}
      ]]>
    </update>

    <delete id="delete">
      <![CDATA[ 
        DELETE FROM fm_board
        WHERE bno=#{bno}
      ]]>
    </delete>

    <select id="getTotalCount" resultType="int">

        SELECT count(bno)
        FROM fm_board

        <where>
          <choose>  
            <when test="category eq 'F'.toString()">
              category='F'
            </when>
                            
            <when test="category eq 'R'.toString()">
              category='R'
            </when>
                            
            <when test="category eq 'B'.toString()">
              category='B'
            </when>
                            
            <when test="category eq 'N'.toString()">
              category='N'
            </when>
            <otherwise>
              bno>0
            </otherwise>  
          </choose>
        </where>

    </select>
    
    <update id="viewCnt" parameterType="int">
      UPDATE fm_board 
      SET view_cnt = view_cnt+1
      where bno=#{bno}
    </update>

    <update id="commentCnt" parameterType="int">
      UPDATE fm_board 
      SET comment_cnt = comment_cnt + #{amount}
      WHERE bno=#{bno}
    </update>


    <insert id="insertLike" parameterType="HashMap">
      <![CDATA[ 
        INSERT INTO liketo(bno,user_id)
        VALUES (#{bno}, #{user_id})
      ]]>
    </insert>

    <select id="likecount" resultType="HashMap">
      <![CDATA[ 
      SELECT COUNT(*)
      FROM liketo
      WHERE bno=${bno}
      ]]>
    </select>

    <update id="like_check" parameterType="HashMap">
      <![CDATA[ 
        UPDATE liketo
        SET like_check = like_check+1
        WHERE user_id=#{user_id}
        AND bno=#{bno}
      ]]>
    </update>

    <update id="like_check_cancel" parameterType="HashMap">
      <![CDATA[ 
        UPDATE liketo
        SET like_check = 0
        WHERE user_id=#{user_id}
        AND bno=#{bno}
      ]]>
    </update>

    <delete id="deletebyBno" parameterType="int">
      <![CDATA[ 
        DELETE FROM liketo
        WHERE bno=#{bno}
      ]]>
    </delete>
            
    <select id="read" resultType="com.filmee.myapp.domain.LiketoVO" parameterType="HashMap">
      select *
      from liketo
      where bno=#{bno}
      and user_id=#{user_id}
    </select>
    
</mapper>